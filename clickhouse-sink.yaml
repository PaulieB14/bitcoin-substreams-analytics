start:
  args:
    - --substreams-endpoint=https://bitcoin.substreams.pinax.network:443/v1/substreams
    - substreams.yaml
    - map_events
    - --clickhouse-url=clickhouse://default:password@localhost:9000/default

network: bitcoin

# ClickHouse Database schema definitions
schema:
  # Cursor table for keeping track of progress
  - name: substreams_cursors
    engine: ReplacingMergeTree
    primary_key: cursor_id
    fields:
      - name: cursor_id
        type: String
      - name: cursor
        type: String
      - name: head_block_number
        type: UInt64
      - name: head_block_timestamp
        type: DateTime64(3)
      - name: created_at
        type: DateTime64(3)
      - name: updated_at
        type: DateTime64(3)

  # Block Analytics Table
  - name: blocks
    engine: ReplacingMergeTree
    primary_key: block_number
    fields:
      - name: block_number
        type: UInt64
      - name: block_hash
        type: String
      - name: timestamp
        type: DateTime64(3)
      - name: size
        type: UInt32
      - name: weight
        type: UInt32
      - name: transaction_count
        type: UInt32
      - name: miner
        type: String
      - name: version
        type: UInt32
      - name: difficulty
        type: String
      - name: protocol_features
        type: String
        codec: "json"

  # Transaction Analytics Table
  - name: transactions
    engine: ReplacingMergeTree
    primary_key: (block_number, transaction_hash)
    fields:
      - name: transaction_hash
        type: String
      - name: block_number
        type: UInt64
      - name: timestamp
        type: DateTime64(3)
      - name: size
        type: UInt32
      - name: weight
        type: UInt32
      - name: virtual_size
        type: UInt32
      - name: fee
        type: UInt64
      - name: fee_rate
        type: Float64
      - name: input_count
        type: UInt32
      - name: output_count
        type: UInt32
      - name: total_input_value
        type: UInt64
      - name: total_output_value
        type: UInt64
      - name: is_coinbase
        type: UInt8
      - name: transaction_type
        type: UInt8
      - name: input_addresses
        type: Array(String)
      - name: output_addresses
        type: Array(String)

  # Address Activity Table
  - name: address_activities
    engine: ReplacingMergeTree
    primary_key: (address, block_number, transaction_hash)
    fields:
      - name: address
        type: String
      - name: block_number
        type: UInt64
      - name: timestamp
        type: DateTime64(3)
      - name: transaction_hash
        type: String
      - name: activity_type
        type: UInt8
      - name: value
        type: UInt64
      - name: balance
        type: UInt64
      - name: utxo_count
        type: UInt32

  # UTXO Table
  - name: utxos
    engine: ReplacingMergeTree
    primary_key: (transaction_hash, output_index)
    fields:
      - name: transaction_hash
        type: String
      - name: output_index
        type: UInt32
      - name: block_number
        type: UInt64
      - name: timestamp
        type: DateTime64(3)
      - name: value
        type: UInt64
      - name: is_spent
        type: UInt8
      - name: spending_transaction_hash
        type: String
      - name: spending_block_number
        type: UInt64
      - name: address
        type: String
      - name: age
        type: UInt64

  # Mempool Stats Table
  - name: mempool_stats
    engine: ReplacingMergeTree
    primary_key: timestamp
    fields:
      - name: timestamp
        type: DateTime64(3)
      - name: transaction_count
        type: UInt32
      - name: total_fee
        type: UInt64
      - name: median_fee_rate
        type: Float64
      - name: high_priority_fee_rate
        type: Float64
      - name: medium_priority_fee_rate
        type: Float64
      - name: low_priority_fee_rate
        type: Float64
      - name: total_mempool_size
        type: UInt64

# Mapping from Substreams data to ClickHouse tables
maps:
  # Map block data
  - module: map_events
    type: bitcoin.analytics.v1.Events
    transforms:
      - transform: blocks
        table: blocks
        fields:
          block_number: proto:blocks.block_number
          block_hash: proto:blocks.block_hash
          timestamp: expr:to_datetime(blocks.timestamp / 1000)
          size: proto:blocks.size
          weight: proto:blocks.weight
          transaction_count: proto:blocks.transaction_count
          miner: proto:blocks.miner
          version: proto:blocks.version
          difficulty: proto:blocks.difficulty
          protocol_features: expr:to_json_string(blocks.protocol_features)

      # Map transaction data
      - transform: transactions
        table: transactions
        fields:
          transaction_hash: proto:transactions.transaction_hash
          block_number: proto:transactions.block_number
          timestamp: expr:to_datetime(blocks[0].timestamp / 1000)
          size: proto:transactions.size
          weight: proto:transactions.weight
          virtual_size: proto:transactions.virtual_size
          fee: proto:transactions.fee
          fee_rate: proto:transactions.fee_rate
          input_count: proto:transactions.input_count
          output_count: proto:transactions.output_count
          total_input_value: proto:transactions.total_input_value
          total_output_value: proto:transactions.total_output_value
          is_coinbase: proto:transactions.is_coinbase
          transaction_type: proto:transactions.type
          input_addresses: proto:transactions.input_addresses
          output_addresses: proto:transactions.output_addresses

      # Map address activity data
      - transform: address_activities
        table: address_activities
        fields:
          address: proto:address_activities.address
          block_number: proto:address_activities.block_number
          timestamp: expr:to_datetime(blocks[0].timestamp / 1000)
          transaction_hash: proto:address_activities.transaction_hash
          activity_type: proto:address_activities.type
          value: proto:address_activities.value
          balance: proto:address_activities.balance
          utxo_count: proto:address_activities.utxo_count

      # Map UTXO data
      - transform: utxos
        table: utxos
        fields:
          transaction_hash: proto:utxos.transaction_hash
          output_index: proto:utxos.output_index
          block_number: proto:utxos.block_number
          timestamp: expr:to_datetime(blocks[0].timestamp / 1000)
          value: proto:utxos.value
          is_spent: proto:utxos.is_spent
          spending_transaction_hash: proto:utxos.spending_transaction_hash
          spending_block_number: proto:utxos.spending_block_number
          address: proto:utxos.address
          age: proto:utxos.age

      # Map mempool stats
      - transform: mempool_stats
        table: mempool_stats
        fields:
          timestamp: expr:to_datetime(mempool_stats.timestamp / 1000)
          transaction_count: proto:mempool_stats.transaction_count
          total_fee: proto:mempool_stats.total_fee
          median_fee_rate: proto:mempool_stats.median_fee_rate
          high_priority_fee_rate: proto:mempool_stats.fee_distribution.high_priority_fee_rate
          medium_priority_fee_rate: proto:mempool_stats.fee_distribution.medium_priority_fee_rate
          low_priority_fee_rate: proto:mempool_stats.fee_distribution.low_priority_fee_rate
          total_mempool_size: proto:mempool_stats.total_mempool_size
